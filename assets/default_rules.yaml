# PerfInspector v0.1 è§„åˆ™é…ç½®
# æ”¯æŒå•ç±»å‹è§„åˆ™å’Œè”åˆåˆ†æè§„åˆ™

rules:
  - id: "memory_growth_trend"
    name: "å†…å­˜æŒç»­å¢é•¿è¶‹åŠ¿"
    profile_types: ["heap"]
    condition: "trends.heap_inuse.slope > 10.0 && trends.heap_inuse.r2 > 0.85 && metricsSeries.length > 3"
    actions:
      - type: "report"
        severity: "high"
        title: "ğŸ“ˆ æŒç»­å†…å­˜å¢é•¿è¶‹åŠ¿"
        evidence_template:
          å†…å­˜å¢é•¿é€Ÿç‡: "{{.slope}}/åˆ†é’Ÿ"
          çº¿æ€§ç›¸å…³åº¦: "{{.r2}} (1.0ä¸ºå®Œç¾çº¿æ€§)"
          æ—¶é—´èŒƒå›´: "{{.duration}}"
        suggestions:
          - "å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œæ£€æŸ¥é•¿æœŸè¿è¡Œçš„å¯¹è±¡"
          - "ä½¿ç”¨ go tool pprof --alloc_space åˆ†æåˆ†é…çƒ­ç‚¹"

  - id: "cpu_spike"
    name: "CPU ä½¿ç”¨ç‡çªå¢"
    profile_types: ["cpu"]
    condition: "current.cpu_usage > baseline.cpu_usage * 2"
    actions:
      - type: "report"
        severity: "medium"
        title: "âš¡ CPU ä½¿ç”¨ç‡çªå¢"
        suggestions:
          - "æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„çƒ­ç‚¹å‡½æ•°"
          - "ä½¿ç”¨ go tool pprof -top æŸ¥çœ‹ CPU æ¶ˆè€—æ’å"

  - id: "cpu_hotspot"
    name: "CPU çƒ­ç‚¹å‡½æ•°åˆ†æ"
    profile_types: ["cpu"]
    condition: "cpu_profile_exists"
    actions:
      - type: "report"
        severity: "medium"
        title: "ğŸ”¥ CPU çƒ­ç‚¹å‡½æ•°åˆ†æ"
        evidence_template:
          åˆ†ææ–‡ä»¶æ•°: "{{.file_count}}"
        suggestions:
          - "æ£€æŸ¥çƒ­ç‚¹å‡½æ•°çš„ç®—æ³•å¤æ‚åº¦ï¼Œè€ƒè™‘ä¼˜åŒ–"
          - "ä½¿ç”¨ go tool pprof -top æŸ¥çœ‹ CPU æ¶ˆè€—æ’å"
          - "ä½¿ç”¨ go tool pprof -list <å‡½æ•°å> æŸ¥çœ‹å…·ä½“ä»£ç è¡Œ"
          - "è€ƒè™‘ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®ç»“æ„æˆ–ç®—æ³•"
          - "å¯¹äºå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œä½¿ç”¨ strings.Builder æ›¿ä»£ + æ“ä½œ"
          - "å¯¹äºé¢‘ç¹çš„å†…å­˜åˆ†é…ï¼Œè€ƒè™‘ä½¿ç”¨ sync.Pool å¤ç”¨å¯¹è±¡"

  - id: "goroutine_leak"
    name: "Goroutine æ³„æ¼"
    profile_types: ["goroutine"]
    condition: "trends.goroutine_count.slope > 1.0 && trends.goroutine_count.r2 > 0.9"
    actions:
      - type: "report"
        severity: "high"
        title: "ğŸ”„ Goroutine æŒç»­å¢é•¿"
        suggestions:
          - "æ£€æŸ¥æ˜¯å¦æœ‰æœªå…³é—­çš„ channel"
          - "æ£€æŸ¥æ˜¯å¦æœ‰é˜»å¡çš„ goroutine"
          - "ä½¿ç”¨ runtime.NumGoroutine() ç›‘æ§ goroutine æ•°é‡"

# è”åˆåˆ†æè§„åˆ™ - è·¨å¤šç§ profile ç±»å‹çš„å…³è”åˆ†æ
cross_analysis_rules:
  - id: "goroutine_memory_leak"
    name: "Goroutine å¯¼è‡´çš„å†…å­˜æ³„æ¼"
    conditions:
      heap: "increasing && slope > 0"
      goroutine: "increasing && slope > 0"
    correlation: "both_increasing"
    actions:
      - type: "report"
        severity: "critical"
        title: "ğŸš¨ Goroutine æ³„æ¼å¯¼è‡´å†…å­˜å¢é•¿"
        evidence_template:
          å†…å­˜å¢é•¿é€Ÿç‡: "{{.heap_slope}}/åˆ†é’Ÿ"
          å†…å­˜è¶‹åŠ¿ç›¸å…³åº¦: "{{.heap_r2}}"
          Goroutineå¢é•¿é€Ÿç‡: "{{.goroutine_slope}} ä¸ª/åˆ†é’Ÿ"
          Goroutineè¶‹åŠ¿ç›¸å…³åº¦: "{{.goroutine_r2}}"
        suggestions:
          - "Goroutine å’Œå†…å­˜åŒæ—¶å¢é•¿ï¼Œé«˜åº¦æ€€ç–‘ goroutine æ³„æ¼"
          - "æ¯ä¸ªæ³„æ¼çš„ goroutine éƒ½ä¼šæŒæœ‰æ ˆå†…å­˜å’Œç›¸å…³å¯¹è±¡"
          - "ä½¿ç”¨ pprof goroutine æŸ¥çœ‹é˜»å¡ç‚¹å’Œæ³„æ¼æº"
          - "æ£€æŸ¥æ˜¯å¦æœ‰æœªå…³é—­çš„ channel æˆ–æ— é™ç­‰å¾…çš„ select"

  - id: "memory_without_goroutine"
    name: "é Goroutine ç›¸å…³çš„å†…å­˜æ³„æ¼"
    conditions:
      heap: "increasing && slope > 0"
      goroutine: "slope <= 0"
    correlation: "time_correlated"
    actions:
      - type: "report"
        severity: "high"
        title: "ğŸ’¾ ç‹¬ç«‹å†…å­˜æ³„æ¼ï¼ˆé Goroutine ç›¸å…³ï¼‰"
        evidence_template:
          å†…å­˜å¢é•¿é€Ÿç‡: "{{.heap_slope}}/åˆ†é’Ÿ"
          å†…å­˜è¶‹åŠ¿ç›¸å…³åº¦: "{{.heap_r2}}"
        suggestions:
          - "å†…å­˜å¢é•¿ä½† Goroutine æ•°é‡ç¨³å®š"
          - "å¯èƒ½æ˜¯ç¼“å­˜æ²¡æœ‰è¿‡æœŸç­–ç•¥"
          - "æ£€æŸ¥å…¨å±€å˜é‡ã€sync.Poolã€è¿æ¥æ± ç­‰"
          - "ä½¿ç”¨ go tool pprof --inuse_space åˆ†æå†…å­˜å ç”¨"
