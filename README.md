# PerfInspector

æ™ºèƒ½æ—¶é—´åºåˆ— pprof åˆ†æå·¥å…·ï¼Œä¸“ä¸º Go åº”ç”¨æ€§èƒ½é—®é¢˜è¯Šæ–­è®¾è®¡ã€‚

## é¡¹ç›®æ¦‚è¿°

PerfInspector æ˜¯ä¸€ä¸ª Go è¯­è¨€æ€§èƒ½åˆ†æå·¥å…·ï¼Œèƒ½å¤Ÿè‡ªåŠ¨åˆ†æ pprof profile æ–‡ä»¶ï¼Œæ£€æµ‹æ€§èƒ½é—®é¢˜è¶‹åŠ¿ï¼Œå®šä½é—®é¢˜æ ¹å› ï¼Œå¹¶ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Šã€‚

### æ ¸å¿ƒç‰¹æ€§

- **æ—¶é—´åºåˆ—åˆ†æ**: æ”¯æŒå¤šä¸ª profile æ–‡ä»¶çš„è¶‹åŠ¿åˆ†æï¼Œè‡ªåŠ¨æ£€æµ‹å†…å­˜æ³„æ¼ã€goroutine æ³„æ¼ç­‰é—®é¢˜
- **æ™ºèƒ½è§„åˆ™å¼•æ“**: åŸºäº YAML é…ç½®çš„è§„åˆ™ç³»ç»Ÿï¼Œæ”¯æŒå•ç±»å‹è§„åˆ™å’Œè·¨ç±»å‹è”åˆåˆ†æ
- **é—®é¢˜å®šä½å™¨**: è‡ªåŠ¨è¯†åˆ«çƒ­ç‚¹è·¯å¾„ï¼ŒåŒºåˆ†ä¸šåŠ¡ä»£ç /æ ‡å‡†åº“/ç¬¬ä¸‰æ–¹åº“/è¿è¡Œæ—¶ä»£ç 
- **å¤šæ ¼å¼æŠ¥å‘Š**: æ”¯æŒæ–‡æœ¬å’Œ HTML ä¸¤ç§æŠ¥å‘Šæ ¼å¼ï¼ŒHTML æŠ¥å‘ŠåŒ…å«äº¤äº’å¼å¯è§†åŒ–
- **å¯æ‰§è¡Œå‘½ä»¤ç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆ pprof è°ƒè¯•å‘½ä»¤ï¼Œæ–¹ä¾¿è¿›ä¸€æ­¥åˆ†æ

## é¡¹ç›®å®Œæˆåº¦

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Profile è§£æ | âœ… å®Œæˆ | æ”¯æŒ CPU/Heap/Goroutine profile |
| åˆ†ç»„ä¸è¶‹åŠ¿åˆ†æ | âœ… å®Œæˆ | çº¿æ€§å›å½’è¶‹åŠ¿æ£€æµ‹ |
| è§„åˆ™å¼•æ“ | âœ… å®Œæˆ | å•ç±»å‹è§„åˆ™ + è”åˆåˆ†æè§„åˆ™ |
| é—®é¢˜å®šä½å™¨ | âœ… å®Œæˆ | çƒ­ç‚¹è·¯å¾„åˆ†æã€ä»£ç åˆ†ç±»ã€æ ¹å› å®šä½ |
| æ–‡æœ¬æŠ¥å‘Š | âœ… å®Œæˆ | ç»ˆç«¯å‹å¥½çš„æ ¼å¼åŒ–è¾“å‡º |
| HTML æŠ¥å‘Š | âœ… å®Œæˆ | äº¤äº’å¼å¯è§†åŒ–æŠ¥å‘Š |
| æµ‹è¯•è¦†ç›– | âœ… å®Œæˆ | å„æ¨¡å—å•å…ƒæµ‹è¯• |

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        main.go                               â”‚
â”‚                    (å‘½ä»¤è¡Œå…¥å£)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  pkg/parser   â”‚    â”‚ pkg/analyzer  â”‚    â”‚  pkg/rules    â”‚
â”‚  Profileè§£æ  â”‚â”€â”€â”€â–¶â”‚   è¶‹åŠ¿åˆ†æ    â”‚â”€â”€â”€â–¶â”‚   è§„åˆ™å¼•æ“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                     â”‚
                              â–¼                     â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ pkg/locator   â”‚â—€â”€â”€â”€â”‚ pkg/reporter  â”‚
                     â”‚  é—®é¢˜å®šä½å™¨   â”‚    â”‚   æŠ¥å‘Šç”Ÿæˆ    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ¨¡å—è¯¦è§£

### 1. Profile è§£æ (`pkg/parser`)

è´Ÿè´£åŠ è½½å’Œè§£æ pprof æ–‡ä»¶ï¼Œæå–æ—¶é—´æˆ³å…ƒæ•°æ®ã€‚

```go
// åŠ è½½ profile æ–‡ä»¶
profile, err := parser.LoadProfile("cpu.pprof")

// è·å– profile æ—¶é—´æˆ³
timestamp := parser.GetProfileTime(profile)
```

### 2. åˆ†æå™¨ (`pkg/analyzer`)

#### 2.1 åˆ†ç»„ (`grouping.go`)
- è‡ªåŠ¨æ£€æµ‹ profile ç±»å‹ (cpu/heap/goroutine/block/mutex)
- æŒ‰ç±»å‹åˆ†ç»„å¹¶æŒ‰æ—¶é—´æ’åº
- æå–æ¯ä¸ª profile çš„æ€§èƒ½æŒ‡æ ‡

#### 2.2 æŒ‡æ ‡æå– (`metrics.go`)
- CPU: CPU æ—¶é—´ã€é‡‡æ ·æ—¶é•¿ã€çƒ­ç‚¹å‡½æ•°
- Heap: åˆ†é…å†…å­˜/å¯¹è±¡ã€ä½¿ç”¨ä¸­å†…å­˜/å¯¹è±¡
- Goroutine: goroutine æ•°é‡ã€é˜»å¡ç‚¹

#### 2.3 è¶‹åŠ¿åˆ†æ (`trends.go`)
- ä½¿ç”¨æœ€å°äºŒä¹˜æ³•è¿›è¡Œçº¿æ€§å›å½’
- è®¡ç®—æ–œç‡å’Œ RÂ² å†³å®šç³»æ•°
- åˆ¤æ–­è¶‹åŠ¿æ–¹å‘ (increasing/decreasing/stable)

### 3. è§„åˆ™å¼•æ“ (`pkg/rules`)

åŸºäº YAML é…ç½®çš„è§„åˆ™ç³»ç»Ÿï¼Œæ”¯æŒä¸¤ç§è§„åˆ™ç±»å‹ï¼š

#### å•ç±»å‹è§„åˆ™
```yaml
rules:
  - id: "memory_growth_trend"
    name: "å†…å­˜æŒç»­å¢é•¿è¶‹åŠ¿"
    profile_types: ["heap"]
    condition: "trends.heap_inuse.slope > 10.0 && trends.heap_inuse.r2 > 0.85"
    actions:
      - type: "report"
        severity: "high"
        title: "ğŸ“ˆ æŒç»­å†…å­˜å¢é•¿è¶‹åŠ¿"
```

#### è”åˆåˆ†æè§„åˆ™
```yaml
cross_analysis_rules:
  - id: "goroutine_memory_leak"
    name: "Goroutine å¯¼è‡´çš„å†…å­˜æ³„æ¼"
    conditions:
      heap: "increasing && slope > 0"
      goroutine: "increasing && slope > 0"
    correlation: "both_increasing"
```

### 4. é—®é¢˜å®šä½å™¨ (`pkg/locator`)

#### 4.1 ä»£ç åˆ†ç±»å™¨ (`classifier.go`)
å°†å‡½æ•°åˆ†ä¸ºå››ç±»ï¼š
- **Runtime**: Go è¿è¡Œæ—¶ (`runtime.*`)
- **Stdlib**: æ ‡å‡†åº“ (`fmt`, `net/http` ç­‰)
- **ThirdParty**: ç¬¬ä¸‰æ–¹åº“ (`github.com/*` ç­‰)
- **Business**: ä¸šåŠ¡ä»£ç  (ç”¨æˆ·æ¨¡å—)

#### 4.2 è°ƒç”¨æ ˆæå–å™¨ (`extractor.go`)
- ä» pprof Sample æå–å®Œæ•´è°ƒç”¨é“¾
- è§£æå‡½æ•°åã€åŒ…åã€æ–‡ä»¶ä½ç½®
- è®¡ç®—æ¯å¸§çš„æ¶ˆè€—å€¼å’Œç™¾åˆ†æ¯”

#### 4.3 çƒ­ç‚¹è·¯å¾„åˆ†æå™¨ (`analyzer.go`)
- èšåˆç›¸åŒè°ƒç”¨è·¯å¾„çš„æ ·æœ¬
- æŒ‰æ¶ˆè€—å€¼æ’åºå– Top N
- è¯†åˆ«ä¸šåŠ¡ä»£ç å¸§å’Œæ ¹å› ä½ç½®

#### 4.4 ä¸Šä¸‹æ–‡ç”Ÿæˆå™¨ (`context.go`)
- ç”Ÿæˆé—®é¢˜è§£é‡Šå’Œå½±å“è¯„ä¼°
- å…³è”çƒ­ç‚¹è·¯å¾„å’Œå»ºè®®
- ç”Ÿæˆå¯æ‰§è¡Œçš„ pprof å‘½ä»¤

#### 4.5 å»ºè®®æ¨¡æ¿ (`suggestions.go`)
é¢„å®šä¹‰çš„ä¼˜åŒ–å»ºè®®æ¨¡æ¿ï¼š
- ç¼“å­˜æ³„æ¼ â†’ LRU/TTL ç¼“å­˜ç¤ºä¾‹
- Channel é˜»å¡ â†’ select è¶…æ—¶ç¤ºä¾‹
- èµ„æºæ³„æ¼ â†’ defer close ç¤ºä¾‹
- Goroutine æ³„æ¼ â†’ context æ§åˆ¶ç¤ºä¾‹
- CPU çƒ­ç‚¹ â†’ ç®—æ³•ä¼˜åŒ–å»ºè®®
- å†…å­˜åˆ†é… â†’ sync.Pool ç¤ºä¾‹

#### 4.6 å‘½ä»¤ç”Ÿæˆå™¨ (`commands.go`)
è‡ªåŠ¨ç”Ÿæˆ pprof è°ƒè¯•å‘½ä»¤ï¼š
- `go tool pprof -top` æŸ¥çœ‹çƒ­ç‚¹
- `go tool pprof -focus=<func>` èšç„¦å‡½æ•°
- `go tool pprof -list=<func>` æºç åˆ†æ
- `go tool pprof -http=:8080` Web å¯è§†åŒ–
- `go tool pprof -base=<base> <target>` å·®å¼‚å¯¹æ¯”

### 5. æŠ¥å‘Šç”Ÿæˆå™¨ (`pkg/reporter`)

#### æ–‡æœ¬æŠ¥å‘Š (`text.go`)
ç»ˆç«¯å‹å¥½çš„æ ¼å¼åŒ–è¾“å‡ºï¼ŒåŒ…å«ï¼š
- Profile åˆ†ç»„ä¿¡æ¯å’ŒæŒ‡æ ‡
- è¶‹åŠ¿åˆ†æç»“æœ
- è§„åˆ™å‘ç°å’Œå»ºè®®
- çƒ­ç‚¹è°ƒç”¨é“¾ï¼ˆå¸¦åˆ†ç±»æ ‡è®°ï¼‰

#### HTML æŠ¥å‘Š (`html.go`)
äº¤äº’å¼å¯è§†åŒ–æŠ¥å‘Šï¼Œç‰¹æ€§ï¼š
- å“åº”å¼è®¾è®¡
- å¯æŠ˜å çš„çƒ­ç‚¹è·¯å¾„
- ä»£ç ç¤ºä¾‹é«˜äº®
- ä¸€é”®å¤åˆ¶å‘½ä»¤
- æ–‡ä»¶é“¾æ¥è·³è½¬

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# åˆ†æç›®å½•ä¸‹æ‰€æœ‰ profile æ–‡ä»¶
./perfinspector ./profiles/

# ç”Ÿæˆ HTML æŠ¥å‘Š
./perfinspector -format html -output report.html ./profiles/

# ä½¿ç”¨è‡ªå®šä¹‰è§„åˆ™
./perfinspector -rules custom_rules.yaml ./profiles/
```

### å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `-format` | text | è¾“å‡ºæ ¼å¼: text, html |
| `-output` | report.html | è¾“å‡ºæ–‡ä»¶è·¯å¾„ |
| `-rules` | assets/default_rules.yaml | è§„åˆ™æ–‡ä»¶è·¯å¾„ |
| `-module` | (è‡ªåŠ¨æ£€æµ‹) | ç”¨æˆ·æ¨¡å—å |
| `-third-party-prefixes` | - | é¢å¤–çš„ç¬¬ä¸‰æ–¹åŒ…å‰ç¼€ |
| `-stack-depth` | 10 | æœ€å¤§è°ƒç”¨æ ˆæ·±åº¦ |
| `-hot-paths` | 5 | æœ€å¤§çƒ­ç‚¹è·¯å¾„æ•° |

### ç¤ºä¾‹

```bash
# åˆ†æ CPU profile
./perfinspector -format html -output cpu_report.html ./cpu_profiles/

# æŒ‡å®šæ¨¡å—åè¿›è¡Œä¸šåŠ¡ä»£ç è¯†åˆ«
./perfinspector -module github.com/myorg/myapp ./profiles/

# å¢åŠ è°ƒç”¨æ ˆæ·±åº¦
./perfinspector -stack-depth 15 -hot-paths 10 ./profiles/
```

## æµ‹è¯•æ•°æ®

é¡¹ç›®åŒ…å«ä¸°å¯Œçš„æµ‹è¯•åœºæ™¯ï¼š

| åœºæ™¯ | ç›®å½• | è¯´æ˜ |
|------|------|------|
| ç¼“å­˜æ³„æ¼ | `scenario1_cache_leak` | æ¨¡æ‹Ÿæ— é™å¢é•¿çš„ç¼“å­˜ |
| Worker æ± æ³„æ¼ | `scenario2_worker_leak` | æ¨¡æ‹Ÿ goroutine æ³„æ¼ |
| Channel æ³„æ¼ | `scenario3_channel_leak` | æ¨¡æ‹Ÿ channel é˜»å¡ |
| CPU çƒ­ç‚¹ | `scenario4_cpu_hotspot` | æ¨¡æ‹Ÿ CPU å¯†é›†è®¡ç®— |
| è¿æ¥æ³„æ¼ | `scenario5_conn_leak` | æ¨¡æ‹Ÿè¿æ¥èµ„æºæ³„æ¼ |

## ä¾èµ–

- `github.com/google/pprof` - pprof æ–‡ä»¶è§£æ
- `gopkg.in/yaml.v3` - YAML é…ç½®è§£æ
- `github.com/stretchr/testify` - æµ‹è¯•æ–­è¨€

## æ„å»º

```bash
# æ„å»º
go build -o perfinspector .

# è¿è¡Œæµ‹è¯•
go test ./...
```

## License

MIT License
